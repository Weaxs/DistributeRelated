# 分布式事务

## CAP定理

CAP定理是由加州大学伯克利分校Eric Brewer教授提出来的，他指出WEB服务无法同时满足以下3个属性：

* 一致性 (Consistency)：客户端都知道一系列的操作都会同时发生(生效)
* 可用性 (Availability)：每个操作都必须以可预期的相应结束
* 分区容错性 (Partition Tolerance)：即使出现单个组件无法可用，操作依然可以完成

## BASE思想

BASE思想是对CAP的延伸，基本思想是即使无法做到强一致性，应用可以采用适合的方式达到最终一致性。同时也有一下3个属性：

* 基本可用 (Basically Availiable)：指分布式系统在出现故障的时候，可以损失部分可用性，需要保证核心可用。服务限流和降级就是其基本表现。
* 软状态 (Soft State)：指允许系统存在中间状态，而中间状态不会影响整体的可用状态。分布式存储中一般一份数据有若干个副本，允许不同节点间副本同步的延时就是软状态的体现
* 最终一致性 (Eventual Consistency)：指系统中所有的数据副本经过一定时间后，最终能够达到一致的状态。


## 事务的ACID特性
            
* 原子性(A)：在整个事务中的所有操作，要么全部完成，要么全部不做，没有中间状态
* 一致性(C)：事务的执行必须保证系统的一致性
* 隔离性(I)：事务与事务之间不会互相影响，一个事务的中间状态不会被其他事务感知
* 持久性(D)：一旦事务完成了，那么事务对数据所做的变更就完全保存在了数据库中，即使发生停电，系统宕机也是如此

## 常见的分布式事务解决方案

### 基于XA协议的两阶段提交(2PC)

XA中大致分为两部分：事务管理器和本地资源管理器。其中本地资源管理器往往由数据库实现，比如Oracle、DB2这些商业数据库都实现了XA接口，而事务管理器作为全局的调度者(一个微服务)，负责各个本地资源的提交和回滚。

* 第一阶段：

事务管理器 ———————————— 预备请求 ————————————▶ 本地资源管理器

事务管理器 ◀———————————— 就绪响应 ———————————— 本地资源管理器

* 第二阶段

事务管理器 ———————————— 提交请求 ————————————▶ 本地资源管理器

事务管理器 ◀———————————— 成功响应 ———————————— 本地资源管理器

如果其中任何一个资源管理器执行失败，则全部回滚

两阶段提交严重依赖数据库层面来搞定复杂的事务，效率低，不适合高并发的场景。

一般来说某个系统内部如果出现跨多个本地资源管理器(数据库)是不合规的。且现在的微服务，我们的规定和规范，要求每个服务只能操作自己对应的一个数据库。

故两阶段提交的应用场景较少。

### 补偿事务 (TCC)

TCC 的全称是： Try 、 Confirm 、 Cancel。TCC编程模式采用的是补偿机制，是两阶段提交的一个变种。

其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿 (撤销) 操作。业务逻辑分为三块：
* Try 阶段只要是对业务系统做检测及资源预留。
* Confirm 阶段只要是对业务系统做确认提交，即在各个服务中执行实际的操作。
* Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。

TCC方案的事务回滚，严重依赖于自己写代码和补偿，会造成补偿代码巨大，业务代码难以维护，所以很少使用。

### Sagas 事务模型

Sagas 事务模型又叫做长时间运行的事务 (Long-running-transaction)

其核心思想就是拆分分布式系统中的长事务为多个短事务，或者叫多个本地事务，然后又Sagas工作流引擎负责协调，如果整个流程正常结束，那么就算是事务成功完成，如果在这过程中出现失败，那么Sagas工作流引擎就会以相反的顺序调用补偿操作，进行业务回滚。

例：此时一个长事务分为T1,T2,T3...Tn的n个短事务，在执行T3是发生了错误，则反向执行T3,T2,T1的补偿服务进行回滚。

Sagas方案更适用于业务流程长、业务流程多的情况
